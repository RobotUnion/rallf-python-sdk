#!/usr/bin/env python3
import signal
import sys
import argparse
import os

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), os.path.pardir)))

from rallf.tools import Communicator

from rallf.cli.rallf_args import RallfArgs
from rallf.tools.execution import Execution
from rallf.tools.robot_factory import RobotFactory
from rallf.tools.runner import Runner
from rallf.tools.task_factory import TaskFactory

p = argparse.ArgumentParser(description="Rallf developer tool")
p.add_argument("command", nargs=1, action="store", choices=["new-task", "run", "event"], help="rallf command")
p.add_argument("task_dir", action="store", nargs="?", default=".", help="task directory (default: current)")
p.add_argument("-f", "--func", dest="func", default=None, action="store", help="the routine to execute (default: None)")
p.add_argument("-r", "--robot", dest="robot", action="store", default=None, help="robot to invoke (default: nullbot)")
p.add_argument("-m", "--mocks", dest="mocks", action="store", default=None, help="mocks directory (default: None)")
p.add_argument("-i", "--input", dest="input", default="{}", action="store", help="task's input in JSON (default: {})")

args = RallfArgs()
p.parse_args(namespace=args)

rf = RobotFactory()

bot = rf.createEmpty() if args.robot is None else rf.createFromDir(args.robot)

r = Runner()

tf = TaskFactory()
task = tf.createFromDir(args.task_dir, bot, sys.stdin, sys.stdout)


def sigint_handler(sig, frame):
    raise InterruptedError()


signal.signal(signal.SIGINT, sigint_handler)

if args.func is not None and args.func not in task.manifest['exports']:
    raise RuntimeError("%s function not exported in package" % args.func)

x = Execution(task, args.func, bot, args.input)

r.execute(x)


